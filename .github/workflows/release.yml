name: Release to Maven Central

on:
  workflow_dispatch:
    inputs:
      releaseVersion:
        description: 'Release version (e.g., 2.0.0)'
        required: true
  push:
    tags:
      - 'v*'

jobs:
  publish:
    name: Publish to Maven Central
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: 'maven'
        server-id: central
        server-username: MAVEN_USERNAME
        server-password: MAVEN_PASSWORD
        gpg-private-key: ${{ secrets.GPG_PRIVATE_KEY }}
        gpg-passphrase: MAVEN_GPG_PASSPHRASE

    - name: Update version (manual dispatch)
      if: github.event_name == 'workflow_dispatch'
      working-directory: library
      run: |
        mvn versions:set -DnewVersion=${{ github.event.inputs.releaseVersion }}
        mvn versions:commit

    - name: Build and publish to Maven Central
      working-directory: library
      env:
        MAVEN_USERNAME: ${{ secrets.MAVEN_CENTRAL_USERNAME }}
        MAVEN_PASSWORD: ${{ secrets.MAVEN_CENTRAL_TOKEN }}
        MAVEN_GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
      run: |
        mvn -B clean deploy -Prelease

    - name: Create GitHub Release
      if: github.event_name == 'workflow_dispatch'
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: v${{ github.event.inputs.releaseVersion }}
        release_name: Release ${{ github.event.inputs.releaseVersion }}
        body: |
          Release ${{ github.event.inputs.releaseVersion }}

          ## Maven Coordinates
          ```xml
          <dependency>
            <groupId>org.jdatepicker</groupId>
            <artifactId>jdatepicker</artifactId>
            <version>${{ github.event.inputs.releaseVersion }}</version>
          </dependency>
          ```
        draft: false
        prerelease: false
